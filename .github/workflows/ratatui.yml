name: Ratatui PR Tests

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  run-tests:
    name: Check PR and Run Tests
    runs-on: ubuntu-latest

    if: startsWith(github.head_ref, '') && endsWith(github.head_ref, '/ratatui')

    steps:
      - name: ğŸ§¾ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: ğŸ§ª Run Tests
        id: test
        continue-on-error: true  # âœ… Do not fail the job on test failure
        working-directory: ./ratatui
        run: |
          echo "ğŸ¬ Running cargo tests..."
          TEST_OUTPUT=$(cargo test -- --nocapture 2>&1)
          echo "$TEST_OUTPUT" > test_output.txt

          if [ $? -ne 0 ]; then
            echo "::set-output name=failed::true"
          else
            echo "::set-output name=failed::false"
          fi

      - name: ğŸ“¦ Read test output
        if: steps.test.outputs.failed == 'true'
        id: testout
        working-directory: ./ratatui
        run: |
          echo "content<<EOF" >> $GITHUB_OUTPUT
          tail -n 50 test_output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ’¬ Comment on PR if Tests Failed
        if: steps.test.outputs.failed == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ğŸ³ Oh lÃ  lÃ ! Tests Failed, Monsieur Chef Code!

            ```
            ${{ steps.testout.outputs.content }}
            ```

            ğŸ‘¨â€ğŸ³ Remy says: _"Zut alors! The soufflÃ© has collapsed!"_

            ğŸ” Please whisk away the bugs and push again for another taste test in Remy's kitchen!

            > _Anyone can cook, but only the bravest can debug!_
