name: Ratatui PR Tests

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write

jobs:
  run-tests:
    name: Check PR and Run Tests
    runs-on: ubuntu-latest

    if: startsWith(github.head_ref, '') && endsWith(github.head_ref, '/ratatui')

    steps:
      - name: 🧾 Checkout Code
        uses: actions/checkout@v3

      - name: 🛠️ Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: 🧪 Run Tests
        id: test
        continue-on-error: true  # ✅ Do not fail the job on test failure
        working-directory: ./ratatui
        run: |
          echo "🎬 Running cargo tests..."
          cargo test -- --nocapture 2>&1 | tee test_output.txt
          echo "failed=$([ $? -eq 0 ] && echo "false" || echo "true")" >> $GITHUB_OUTPUT

      - name: 📦 Read test output
        id: testout
        working-directory: ./ratatui
        shell: bash
        run: |
          if [ -f test_output.txt ]; then
            echo "content<<EOF" >> $GITHUB_OUTPUT
            tail -n 50 test_output.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "content=No test output file found" >> $GITHUB_OUTPUT
          fi

      - name: 💬 Comment on PR if Tests Failed
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### 🍳 Oh là là! Tests Failed, Monsieur Chef Code!

            ```
            ${{ steps.testout.outputs.content }}
            ```

            👨‍🍳 Remy says: _"Zut alors! The soufflé has collapsed!"_

            🔁 Please whisk away the bugs and push again for another taste test in Remy's kitchen!

            > _Anyone can cook, but only the bravest can debug!_
