name: Ratatui PR Tests

on:
  pull_request:
    branches: [main]
    workflow_dispatch:
jobs:
  run-tests:
    name: Check PR and Run Tests
    runs-on: ubuntu-latest

    if: startsWith(github.head_ref, '') && endsWith(github.head_ref, '/ratatui')

    steps:
      - name: ðŸ§¾ Checkout Code
        uses: actions/checkout@v3

      - name: ðŸ› ï¸ Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: ðŸ§ª Run Tests
        id: test
        working-directory: ./ratatui
        run: |
          echo "ðŸŽ¬ Running cargo tests..."
          TEST_OUTPUT=$(cargo test -- --nocapture 2>&1)
          echo "$TEST_OUTPUT" > test_output.txt
          echo "$TEST_OUTPUT"
          echo "##[set-output name=failed::$([ $? -ne 0 ] && echo true || echo false)]"
          echo "##[set-output name=stdout::$TEST_OUTPUT]"

      - name: ðŸ’¬ Comment on PR if Tests Failed
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const failed = '${{ steps.test.outputs.failed }}';
            if (failed === 'true') {
              const output = fs.readFileSync('test_output.txt', 'utf8');
              const comment = [
                "### ðŸ³ Oh lÃ  lÃ ! Tests Failed, Monsieur Chef Code!",
                        "",
                        "```\n" + output + "\n```",
                        "",
                        "ðŸ‘¨â€ðŸ³ Remy says: 'Zut alors! The soufflÃ© has collapsed!'",
                        "ðŸ” Please whisk away the bugs and push again for another taste test in Remy's kitchen!",
                        "",
                        "> _Anyone can cook, but only the bravest can debug!_"
              ].join('\n');

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
